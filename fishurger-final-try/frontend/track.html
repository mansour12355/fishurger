<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Your Order - Fish Burger Essaouira</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        red: {
                            50: '#fff5f0',
                            100: '#ffebe0',
                            200: '#ffd4bf',
                            300: '#ffb899',
                            400: '#ff7733',
                            500: '#FF4500',
                            600: '#FF4500',
                            700: '#cc3700',
                            800: '#992900',
                            900: '#661c00',
                            950: '#330e00',
                        }
                    }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;500;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'DM Sans', sans-serif;
        }

        h1,
        h2,
        h3,
        h4,
        .serif {
            font-family: 'Playfair Display', serif;
        }

        /* Pulse animation for active delivery */
        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }

            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        .pulse-ring::before {
            content: '';
            position: absolute;
            inset: -8px;
            border-radius: 50%;
            border: 3px solid currentColor;
            animation: pulse-ring 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Motorcycle animation */
        @keyframes drive {

            0%,
            100% {
                transform: translateX(0);
            }

            50% {
                transform: translateX(10px);
            }
        }

        .animate-drive {
            animation: drive 1s ease-in-out infinite;
        }

        /* Timeline styling */
        .timeline-step {
            position: relative;
        }

        .timeline-step::after {
            content: '';
            position: absolute;
            left: 24px;
            top: 48px;
            width: 2px;
            height: calc(100% - 48px);
            background: #e2e8f0;
        }

        .timeline-step:last-child::after {
            display: none;
        }

        .timeline-step.completed::after {
            background: linear-gradient(to bottom, #22c55e, #22c55e);
        }

        .timeline-step.active::after {
            background: linear-gradient(to bottom, #22c55e, #e2e8f0);
        }
    </style>
</head>

<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">

    <!-- Redirection Logic -->
    <script>
            (function () {
                const storedLocation = localStorage.getItem('selectedLocation');
                if (!storedLocation) {
                    window.location.href = 'index.html';
                }
            })();
    </script>

    <!-- Header -->
    <header class="bg-[#1e3a8a] text-white py-4 lg:py-6 sticky top-0 z-40 shadow-xl">
        <div class="container mx-auto px-4 lg:px-6">
            <div class="flex justify-between items-center">
                <a href="main.html" class="flex items-center gap-3 group">
                    <div
                        class="bg-red-600 text-white w-10 h-10 lg:w-12 lg:h-12 rounded-full flex items-center justify-center text-lg lg:text-xl shadow-lg">
                        <i class="fa-solid fa-burger"></i>
                    </div>
                    <div class="leading-tight">
                        <span class="block font-bold text-lg lg:text-xl tracking-wider uppercase">FishBurger</span>
                        <span
                            class="block text-[10px] lg:text-xs font-medium tracking-widest opacity-80">ESSAOUIRA</span>
                    </div>
                </a>

                <div class="flex items-center gap-3">
                    <a href="order.html"
                        class="bg-white/10 backdrop-blur-md border border-white/20 px-4 py-2 rounded-full text-sm font-bold hover:bg-white/20 transition-all flex items-center gap-2">
                        <i class="fa-solid fa-plus"></i>
                        <span class="hidden sm:inline">New Order</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 lg:px-6 py-8 lg:py-12">
        <!-- Search Section -->
        <div id="search-section" class="max-w-xl mx-auto">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-blue-100 rounded-full mb-6">
                    <i class="fa-solid fa-location-dot text-4xl text-blue-600"></i>
                </div>
                <h1 class="text-3xl lg:text-4xl font-bold text-blue-950 mb-3">Track Your Order</h1>
                <p class="text-slate-600">Enter your order number to see real-time delivery status</p>
            </div>

            <div class="bg-white rounded-3xl shadow-2xl p-6 lg:p-8 border border-slate-100">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i class="fa-solid fa-hashtag text-slate-400"></i>
                    </div>
                    <input type="text" id="order-number-input" placeholder="Enter Order Number (e.g., 1234)"
                        class="w-full rounded-xl border-2 border-slate-200 py-4 pl-12 pr-4 text-slate-800 placeholder:text-slate-400 focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 text-lg font-bold text-center tracking-widest"
                        maxlength="4">
                </div>
                <button onclick="searchOrder()"
                    class="w-full mt-4 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-600/30 flex items-center justify-center gap-3 transition-all active:scale-95">
                    <i class="fa-solid fa-search"></i>
                    <span>Track Order</span>
                </button>
                <div id="error-message"
                    class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-xl text-red-600 text-sm font-medium text-center">
                    <i class="fa-solid fa-exclamation-circle mr-2"></i>
                    <span>Order not found. Please check your order number.</span>
                </div>
            </div>
        </div>

        <!-- Tracking Result Section (Hidden by default) -->
        <div id="tracking-section" class="hidden max-w-2xl mx-auto">
            <!-- Order Header -->
            <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-100 mb-6">
                <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 lg:p-8">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-blue-200 text-sm font-medium mb-1">Order Number</div>
                            <div id="display-order-number" class="text-3xl font-black tracking-wider">#0000</div>
                        </div>
                        <div id="status-badge"
                            class="px-4 py-2 rounded-full font-bold text-sm bg-white/20 backdrop-blur-sm">
                            Pending
                        </div>
                    </div>
                </div>

                <!-- Live Status Indicator -->
                <div id="delivery-indicator"
                    class="hidden bg-gradient-to-r from-green-500 to-emerald-600 text-white p-4 flex items-center justify-center gap-4">
                    <div class="relative text-2xl pulse-ring text-green-300">
                        <i class="fa-solid fa-motorcycle animate-drive"></i>
                    </div>
                    <div class="text-center">
                        <div class="font-bold text-lg">Your order is on its way!</div>
                        <div class="text-green-100 text-sm">The driver is heading to your location</div>
                    </div>
                </div>

                <!-- Order Details -->
                <div class="p-6 lg:p-8">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-receipt text-blue-600"></i>
                        Order Details
                    </h3>
                    <div id="order-items" class="space-y-2 mb-4">
                        <!-- Items inserted here -->
                    </div>
                    <div class="border-t border-slate-100 pt-4">
                        <div class="flex justify-between items-center font-bold text-lg">
                            <span class="text-slate-600">Total</span>
                            <span id="order-total" class="text-blue-950">0 DH</span>
                        </div>
                    </div>

                    <!-- Customer Info -->
                    <div class="mt-6 pt-6 border-t border-slate-100">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-truck text-blue-600"></i>
                            Delivery To
                        </h3>
                        <div id="customer-info" class="bg-slate-50 rounded-xl p-4 space-y-2 text-sm">
                            <!-- Customer info inserted here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Timeline -->
            <div class="bg-white rounded-3xl shadow-2xl p-6 lg:p-8 border border-slate-100">
                <h3 class="font-bold text-slate-800 mb-6 flex items-center gap-2">
                    <i class="fa-solid fa-timeline text-blue-600"></i>
                    Order Progress
                </h3>

                <div id="timeline" class="space-y-0">
                    <!-- Pending/Received -->
                    <div class="timeline-step" data-status="pending">
                        <div class="flex items-start gap-4 pb-8">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center shrink-0 bg-slate-100 text-slate-400 border-2 border-slate-200 transition-all"
                                data-icon>
                                <i class="fa-solid fa-clipboard-check text-lg"></i>
                            </div>
                            <div class="flex-1 pt-2">
                                <div class="font-bold text-slate-800">Order Received</div>
                                <div class="text-sm text-slate-500">Your order has been received</div>
                            </div>
                        </div>
                    </div>

                    <!-- Preparing -->
                    <div class="timeline-step" data-status="preparing">
                        <div class="flex items-start gap-4 pb-8">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center shrink-0 bg-slate-100 text-slate-400 border-2 border-slate-200 transition-all"
                                data-icon>
                                <i class="fa-solid fa-fire-burner text-lg"></i>
                            </div>
                            <div class="flex-1 pt-2">
                                <div class="font-bold text-slate-800">Preparing</div>
                                <div class="text-sm text-slate-500">Kitchen is preparing your food</div>
                            </div>
                        </div>
                    </div>

                    <!-- Ready -->
                    <div class="timeline-step" data-status="ready">
                        <div class="flex items-start gap-4 pb-8">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center shrink-0 bg-slate-100 text-slate-400 border-2 border-slate-200 transition-all"
                                data-icon>
                                <i class="fa-solid fa-check text-lg"></i>
                            </div>
                            <div class="flex-1 pt-2">
                                <div class="font-bold text-slate-800">Ready for Pickup</div>
                                <div class="text-sm text-slate-500">Order ready, waiting for driver</div>
                            </div>
                        </div>
                    </div>

                    <!-- Out for Delivery -->
                    <div class="timeline-step" data-status="out-for-delivery">
                        <div class="flex items-start gap-4 pb-8">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center shrink-0 bg-slate-100 text-slate-400 border-2 border-slate-200 transition-all"
                                data-icon>
                                <i class="fa-solid fa-motorcycle text-lg"></i>
                            </div>
                            <div class="flex-1 pt-2">
                                <div class="font-bold text-slate-800">Out for Delivery</div>
                                <div class="text-sm text-slate-500">Driver is on the way to you</div>
                            </div>
                        </div>
                    </div>

                    <!-- Delivered -->
                    <div class="timeline-step" data-status="completed">
                        <div class="flex items-start gap-4">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center shrink-0 bg-slate-100 text-slate-400 border-2 border-slate-200 transition-all"
                                data-icon>
                                <i class="fa-solid fa-house-chimney text-lg"></i>
                            </div>
                            <div class="flex-1 pt-2">
                                <div class="font-bold text-slate-800">Delivered</div>
                                <div class="text-sm text-slate-500">Enjoy your meal!</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Back Button -->
            <div class="mt-6 text-center">
                <button onclick="goBack()" class="text-blue-600 hover:text-blue-800 font-bold transition-colors">
                    <i class="fa-solid fa-arrow-left mr-2"></i>
                    Track Another Order
                </button>
            </div>
        </div>
    </main>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, query, where, onSnapshot, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAbkJpVWRXfOuG-VDp0dC0oGkPKo9VCZD0",
            authDomain: "fishburger-system.firebaseapp.com",
            projectId: "fishburger-system",
            storageBucket: "fishburger-system.firebasestorage.app",
            messagingSenderId: "1011829893886",
            appId: "1:1011829893886:web:626820e2eb475b2b45d3af",
            measurementId: "G-LHF8XPTL3G"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUnsubscribe = null;

        // Status order for timeline
        const statusOrder = ['pending', 'preparing', 'ready', 'out-for-delivery', 'completed'];

        // Search for order
        window.searchOrder = async function () {
            const orderNumber = document.getElementById('order-number-input').value.trim();
            const errorMsg = document.getElementById('error-message');

            if (!orderNumber) {
                errorMsg.classList.remove('hidden');
                errorMsg.querySelector('span').textContent = 'Please enter an order number.';
                return;
            }

            errorMsg.classList.add('hidden');

            try {
                // Query for the order
                const q = query(
                    collection(db, 'orders'),
                    where('orderNumber', '==', parseInt(orderNumber))
                );

                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    errorMsg.classList.remove('hidden');
                    errorMsg.querySelector('span').textContent = 'Order not found. Please check your order number.';
                    return;
                }

                // Get the order document
                const orderDoc = snapshot.docs[0];
                const orderId = orderDoc.id;

                // Show tracking section
                document.getElementById('search-section').classList.add('hidden');
                document.getElementById('tracking-section').classList.remove('hidden');

                // Set up real-time listener
                setupOrderListener(orderId);

            } catch (error) {
                console.error('Error searching order:', error);
                errorMsg.classList.remove('hidden');
                errorMsg.querySelector('span').textContent = 'Error searching for order. Please try again.';
            }
        }

        // Set up real-time listener for order updates
        function setupOrderListener(orderId) {
            // Unsubscribe from previous listener if exists
            if (currentUnsubscribe) {
                currentUnsubscribe();
            }

            const q = query(
                collection(db, 'orders'),
                where('__name__', '==', orderId)
            );

            currentUnsubscribe = onSnapshot(q, (snapshot) => {
                if (!snapshot.empty) {
                    const order = {
                        id: snapshot.docs[0].id,
                        ...snapshot.docs[0].data()
                    };
                    updateTrackingUI(order);
                }
            }, (error) => {
                console.error('Error listening to order:', error);
            });
        }

        // Update the tracking UI with order data
        function updateTrackingUI(order) {
            // Update order number
            document.getElementById('display-order-number').textContent =
                '#' + String(order.orderNumber || 0).padStart(4, '0');

            // Update status badge
            const statusBadge = document.getElementById('status-badge');
            const statusText = getStatusText(order.status);
            statusBadge.textContent = statusText;
            statusBadge.className = 'px-4 py-2 rounded-full font-bold text-sm ' + getStatusBadgeClass(order.status);

            // Show/hide delivery indicator
            const deliveryIndicator = document.getElementById('delivery-indicator');
            if (order.status === 'out-for-delivery') {
                deliveryIndicator.classList.remove('hidden');
            } else {
                deliveryIndicator.classList.add('hidden');
            }

            // Update order items
            const itemsContainer = document.getElementById('order-items');
            if (order.items && order.items.length > 0) {
                itemsContainer.innerHTML = order.items.map(item => `
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-slate-700">${item.name} ${item.quantity > 1 ? 'x' + item.quantity : ''}</span>
                        <span class="text-slate-500 font-medium">${item.priceStr || item.price + ' DH'}</span>
                    </div>
                `).join('');
            } else {
                itemsContainer.innerHTML = '<div class="text-slate-400 text-sm">No items</div>';
            }

            // Update total
            document.getElementById('order-total').textContent = (order.total || 0) + ' DH';

            // Update customer info
            const customerInfo = document.getElementById('customer-info');
            customerInfo.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-user text-slate-400"></i>
                    <span class="font-medium text-slate-800">${order.customer?.name || 'Unknown'}</span>
                </div>
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-phone text-slate-400"></i>
                    <span class="text-slate-600">${order.customer?.phone || 'N/A'}</span>
                </div>
                <div class="flex items-start gap-2">
                    <i class="fa-solid fa-location-dot text-slate-400 mt-0.5"></i>
                    <span class="text-slate-600">${order.customer?.address || 'No address'}</span>
                </div>
            `;

            // Update timeline
            updateTimeline(order.status);
        }

        // Update timeline based on status
        function updateTimeline(currentStatus) {
            const currentIndex = statusOrder.indexOf(currentStatus);
            const timelineSteps = document.querySelectorAll('.timeline-step');

            timelineSteps.forEach((step, index) => {
                const icon = step.querySelector('[data-icon]');
                const stepStatus = step.dataset.status;
                const stepIndex = statusOrder.indexOf(stepStatus);

                // Reset classes
                step.classList.remove('completed', 'active');

                if (stepIndex < currentIndex) {
                    // Completed step
                    step.classList.add('completed');
                    icon.className = 'w-12 h-12 rounded-full flex items-center justify-center shrink-0 bg-green-500 text-white border-2 border-green-500 transition-all';
                } else if (stepIndex === currentIndex) {
                    // Current/active step
                    step.classList.add('active');
                    icon.className = 'w-12 h-12 rounded-full flex items-center justify-center shrink-0 bg-blue-500 text-white border-2 border-blue-500 transition-all animate-pulse';
                } else {
                    // Future step
                    icon.className = 'w-12 h-12 rounded-full flex items-center justify-center shrink-0 bg-slate-100 text-slate-400 border-2 border-slate-200 transition-all';
                }
            });
        }

        // Get human-readable status text
        function getStatusText(status) {
            const statusMap = {
                'pending': 'Pending',
                'preparing': 'Preparing',
                'ready': 'Ready',
                'out-for-delivery': 'On the Way',
                'completed': 'Delivered'
            };
            return statusMap[status] || status;
        }

        // Get status badge colors
        function getStatusBadgeClass(status) {
            const classMap = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'preparing': 'bg-orange-100 text-orange-800',
                'ready': 'bg-green-100 text-green-800',
                'out-for-delivery': 'bg-blue-100 text-blue-800',
                'completed': 'bg-emerald-100 text-emerald-800'
            };
            return classMap[status] || 'bg-slate-100 text-slate-800';
        }

        // Go back to search
        window.goBack = function () {
            if (currentUnsubscribe) {
                currentUnsubscribe();
                currentUnsubscribe = null;
            }
            document.getElementById('search-section').classList.remove('hidden');
            document.getElementById('tracking-section').classList.add('hidden');
            document.getElementById('order-number-input').value = '';
        }

        // Check for order number in URL params
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const orderNumber = urlParams.get('order');
            if (orderNumber) {
                document.getElementById('order-number-input').value = orderNumber;
                searchOrder();
            }
        });

        // Allow Enter key to search
        document.getElementById('order-number-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchOrder();
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (currentUnsubscribe) {
                currentUnsubscribe();
            }
        });
    </script>
</body>

</html>